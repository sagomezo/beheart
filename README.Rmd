---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# beheart

The goal of `beHeart` is to simplify the creation of bull's eye plots for left ventricle segmental data, supporting both 16- and 17-segment models. It provides functions to visualize raw or summarized data, including comparisons between groups.

## Installation

You can install the development version of beheart from [GitHub](https://github.com) with:

``` r
# install.packages("devtools")
devtools::install_github("sagomezo/beheart")
```

## The `beHeart` Workflow

Visualizing your data with `beHeart` is a simple two-step process:

1.  **Prepare Your Data**: Get your data into the correct "long" format.
2.  **Plot**: Use one of the plotting functions to create your bull's eye plot.

### Step 1: Understanding and Preparing Your Data

The main plotting function, `plot_bullseye_from_df()`, requires data in a **long format**. This means you need a data frame with (at minimum) two columns:

* A **segment column**: This tells the package which of the 17 segments the measurement belongs to. This column must contain numbers from 1 to 17.
* A **value column**: This contains the actual measurement for that segment (e.g., a strain value).

#### From "Wide" to "Long" with `prepare_bullseye_data()`

Most clinical datasets are in a **wide format**, with one row per patient and a separate column for each of the 17 segments. `beheart` provides a helper function, `prepare_bullseye_data()`, to easily convert this into the required long format.

Here's how it works:

```{r data-prep}
library(beHeart)

# 1. Start with your "wide" data (one row per subject)
# Your column names for the segments can be anything.
set.seed(42)
wide_dataset <- data.frame(
  subject_id = paste0("SUBJ_", 1:5),
  group = rep(c("A", "B"), length.out = 5),
  b_ant = rnorm(5, -18), b_as = rnorm(5, -21), b_is = rnorm(5, -14),
  b_inf = rnorm(5, -12), b_il = rnorm(5, -8), b_al = rnorm(5, -16),
  m_ant = rnorm(5, -16), m_as = rnorm(5, -20), m_is = rnorm(5, -18),
  m_inf = rnorm(5, -18), m_il = rnorm(5, -10), m_al = rnorm(5, -19),
  a_ant = rnorm(5, -14), a_sept = rnorm(5, -15), a_inf = rnorm(5, -5),
  a_lat = rnorm(5, -14), apex = rnorm(5, -3)
)

print(head(wide_dataset))

# 2. Create a "map" that links your column names to the standard 1-17 segment numbers.
segment_name_map <- c(
  "b_ant" = 1, "b_as" = 2, "b_is" = 3, "b_inf" = 4, "b_il" = 5, "b_al" = 6,
  "m_ant" = 7, "m_as" = 8, "m_is" = 9, "m_inf" = 10, "m_il" = 11, "m_al" = 12,
  "a_ant" = 13, "a_sept" = 14, "a_inf" = 15, "a_lat" = 16, "apex" = 17
)

# 3. Reshape the data
long_dataset <- prepare_bullseye_data(
  data = wide_dataset,
  segment_map = segment_name_map,
  id_cols = c("subject_id", "group"), # These columns will be kept
  values_to = "strain_value"          # The name of your new value column
)

# The data is now in the correct long format
print(head(long_dataset))
```

The resulting `long_dataset` is now perfectly formatted for plotting.

### Step 2: Plotting Your Data

Once your data is in the long format, you can use `plot_bullseye_from_df()` to create a huge variety of plots.

#### Example 1: Basic Plot

A simple call to create a plot summarizing the mean and standard deviation for each segment.

```{r example-basic}
plot_bullseye_from_df(
  df = long_dataset,
  group_col = segment,
  value_col = strain_value
)
```

#### Example 2: Faceted Plot with Customizations

The true power of `beheart` is in comparing groups and customizing the output. Here, we create a side-by-side plot comparing two groups, one with hypertensive heart disease and controls, using the clinical "echo" palette and custom labels.

```{r example-faceted, fig.width=11, fig.height=6}
# Create a complete sample dataset for this example
set.seed(42)
n_subjects <- 40
wide_dataset_full <- data.frame(
  subject_id = paste0("SUBJ_", 1:n_subjects),
  hypertension = sample(c("Yes", "No"), n_subjects, replace = TRUE, prob = c(0.5, 0.5)),
  b_ant = rnorm(n_subjects, -20, 3), b_as = rnorm(n_subjects, -21, 3),
  b_is = rnorm(n_subjects, -22, 3), b_inf = rnorm(n_subjects, -23, 3),
  b_il = rnorm(n_subjects, -22, 3), b_al = rnorm(n_subjects, -21, 3),
  m_ant = rnorm(n_subjects, -19, 3), m_as = rnorm(n_subjects, -20, 3),
  m_is = rnorm(n_subjects, -21, 3), m_inf = rnorm(n_subjects, -22, 3),
  m_il = rnorm(n_subjects, -21, 3), m_al = rnorm(n_subjects, -20, 3),
  a_ant = rnorm(n_subjects, -18, 4), a_sept = rnorm(n_subjects, -19, 4),
  a_inf = rnorm(n_subjects, -20, 4), a_lat = rnorm(n_subjects, -19, 4),
  apex = rnorm(n_subjects, -17, 5)
)

# --- Simulate hypertensive heart disease pattern ---
is_hypertensive <- wide_dataset_full$hypertension == "Yes"
basal_cols <- c("b_ant", "b_as", "b_is", "b_inf", "b_il", "b_al")
mid_cols <- c("m_ant", "m_as", "m_is", "m_inf", "m_il", "m_al")


wide_dataset_full[is_hypertensive, c(basal_cols, mid_cols)] <-
  wide_dataset_full[is_hypertensive, c(basal_cols, mid_cols)] + 6

wide_dataset_full[is_hypertensive, c("b_as", "b_is")] <-
  wide_dataset_full[is_hypertensive, c("b_as", "b_is")] + 7

# --- Reshape and Plot ---
segment_name_map_full <- c(
  "b_ant" = 1, "b_as" = 2, "b_is" = 3, "b_inf" = 4, "b_il" = 5, "b_al" = 6,
  "m_ant" = 7, "m_as" = 8, "m_is" = 9, "m_inf" = 10, "m_il" = 11, "m_al" = 12,
  "a_ant" = 13, "a_sept" = 14, "a_inf" = 15, "a_lat" = 16, "apex" = 17
)

long_dataset_full <- prepare_bullseye_data(
  data = wide_dataset_full,
  segment_map = segment_name_map_full,
  id_cols = c("subject_id", "hypertension"),
  values_to = "strain_value"
)

# Create the final, faceted plot
plot_bullseye_from_df(
  df = long_dataset_full,
  group_col = segment,
  value_col = strain_value,
  facet_by = hypertension,
  facet_labels = c("Yes" = "Hypertensive", "No" = "Normotensive"),
  palette = "echo",
  value_name = "Segmental Strain (%)"
)
```

#### Example 3: Plotting Pre-summarized Data

If you already have a single value for each segment (e.g., from a paper or another analysis), you can use `plot_bullseye_from_vector()`.

```{r example-vector}
# A vector of 17 correlation coefficients
correlation_values <- runif(17, 0.1, 0.8)

plot_bullseye_from_vector(
  data = correlation_values,
  model = 17,
  value_name = bquote(R^2), # Use bquote for special characters
  palette = c("beige", "orangered") # A simple continuous scale
)
```
